<project name="Emacs" default="dist">
  <description>
  Provides a sensor for the Emacs IDE that records DevEvent event data.
  </description>

  <!-- Always make environment variables available with the "env." prefix. --> 
  <property environment="env"/> 

  <!-- Make sure that the SensorBase library is available . --> 
  <available file="${env.HACKYSTAT_SENSORSHELL_HOME}/sensorshell.jar" type="file" property="hackystat.sensorshell.available"/>
  <fail message="This package requires the Hackystat SensorShell to be installed and HACKYSTAT_SENSORSHELL_HOME defined" unless="hackystat.sensorshell.available"/>   

  <!-- Basic properties for this system. --> 
  <property name="system.name" value="hackystat-sensor-emacs" />
  <property name="majorVersionNumber" value="8" />
  <property name="minorVersionNumber" value="0" />
  <tstamp>
    <format property="DAYSTAMP" pattern="Mdd" />
  </tstamp>
  <property name="version" value="${majorVersionNumber}.${minorVersionNumber}.${DAYSTAMP}" />

  <property name="src.dir" location="${basedir}/src"/>
  <property name="build.dir" location="${basedir}/build"/>

  <target name="build">  	
    <filter token="hackystat.version" value="${version}"/>
  
    <copy file="${src.dir}/sensor-utils.el" tofile="${src.dir}/sensor-utils-filtered.el" filtering="on" overwrite="on"/>
    
    <mkdir dir="${build.dir}" />
    <concat destfile="${build.dir}/sensor-package.el">
      <filelist dir="${src.dir}"
                files="sensor-utils-filtered.el,sensor-properties.el,sensorshell.el,devevent-sensor.el,bufftrans-sensor.el, sensor-hooks.el"/>
    </concat>
    <!-- Get rid of the temp file created with the version info embedded. -->
    <delete file="${src.dir}/sensor-utils.filtered.el"/>
  </target>

  <target name="dist" depends="clean, build" description="Create a distribution package.">
    <!-- Define the directories and distribution name -->
    <property name="dist.dir" location="${build.dir}/dist" />
    <property name="dist.tmp.dir" location="${basedir}/dist-tmp" />
    <property name="dist.name" value="${system.name}-${version}" />

    <!-- Copy distribution files to the tmp dir. -->
    <mkdir dir="${dist.tmp.dir}/${dist.name}" />
    <copy todir="${dist.tmp.dir}/${dist.name}">
      <fileset dir="${env.HACKYSTAT_SENSORSHELL_HOME}" includes="sensorshell.jar" />
    </copy>
    <copy todir="${dist.tmp.dir}/${dist.name}">
      <fileset file="${build.dir}/sensor-package.el" />
      <fileset file="${basedir}/README.html" />
    </copy>

    <!-- Create the zip distribution of this system, and then delete the tmp dir. -->
    <mkdir dir="${dist.dir}" />
    <zip zipfile="${dist.dir}/${system.name}-${version}.zip" basedir="${dist.tmp.dir}" />
    <delete dir="${dist.tmp.dir}"/>   
  </target>
  
  <target name="clean" description="Delete build/ directory and top-level jar files.">
    <delete>
      <fileset dir="${basedir}" includes="*.jar"/> 
    </delete>
    <delete dir="${build.dir}"/> 
  </target>

  <target name="convertLineEndings" description="Makes line endings compatible with host platform.">
    <fixcrlf srcdir="${basedir}" includes="*.build.xml"/>
  </target>

</project>

